# 메인 마크다운(README.md)
[▶ 메인 마크다운.md](README.md)

# Redis Install 
<details>
<summary>펼치기/접기</summary>

아마존 AWS EC2 서버를 사용하는 강의와는 다르게, 로컬에 설치한다.
https://github.com/microsoftarchive/redis/releases  
위 링크에서 msi 혹은 zip파일을 다운로드 한다.  
https://dnl1029.tistory.com/49  
설치 과정은 해당 블로그를 참조한다.
</details>

# Redis 주요 설정-1
<details>
<summary>펼치기/접기</summary>

설치 완료 후 redis-cli.exe 파일을 실행시킨다.
```
redis-server.exe redis.windows.conf
```

info 명령을 입력한다.
```bash
127.0.0.1:6379> info
```

```text/plain
# Server
/* 생략 */
redis_mode:standalone
/* 생략 */
# Replication
role:master
/* 생략 */
```
위와 같이 standalone 모드에 master role로 설정되어있다.
우리는 replica 역할을 할거기 때문에 replica 설정을 한다.
인강에서는 master용 인스턴스와 repilca용 인스턴스를 따로 구성하였으나, 현재는 로컬로 기동하기에 포트로 구분하여 접속한다.  

아래 링크를 참조한다.  
[참조 블로그](https://ssjeong.tistory.com/entry/Redis-%EB%A0%88%EB%94%94%EC%8A%A4-Windows%EC%97%90%EC%84%9C-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EA%B5%AC%EB%8F%99%ED%95%98%EA%B8%B0standalone-cluster#%23%C2%A0Redis%C2%A0Standalone%20Slave%20%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0-1)


```bash
redis-server --port 6380 --replicaof 127.0.0.1 6379
```
(5.0버전 미만인 경우 replcaof가 아닌 slaveof 옵션을 사용해야 함.)

위 명령어는 redis를 즉시 실행하지만, redis를 재시작 할 경우 설정이 유지되지 않으므로, 지속적인 설정을 원한다면 설정 파일을 수정해야 한다.

## Redis Version 5.0 이상인경우
replicaof 옵션을 사용한다.

- redis.window.config
  ```text/plain
  ################################ GENERAL  #####################################

  # On Windows, daemonize and pidfile are not supported.
  # However, you can run redis as a Windows service, and specify a logfile.
  # The logfile will contain the pid.

  # Accept connections on the specified port, default is 6379.
  # If port 0 is specified Redis will not listen on a TCP socket.
  # port 6379 # 기존 기본 port 주석
  port 6380
  replicaof 127.0.0.1 6379  
  ```

## Redis Version 5.0 미만인경우 (현재 3.0)
slaveof 옵션을 사용한다.

- redis.window.config
  ```text/plain
  ################################ GENERAL  #####################################

  # On Windows, daemonize and pidfile are not supported.
  # However, you can run redis as a Windows service, and specify a logfile.
  # The logfile will contain the pid.

  # Accept connections on the specified port, default is 6379.
  # If port 0 is specified Redis will not listen on a TCP socket.
  # port 6379 # 기존 기본 port 주석
  port 6380
  slaveof 127.0.0.1 6379  
  ```
- slave 실행
  ```bash
  redis-server.exe redis.windows.conf
  ```

### 실패 1

```text/plain
[28616] 29 Dec 02:32:57.339 * Non blocking connect for SYNC fired the event.
[28616] 29 Dec 02:32:57.339 # Sending command to master in replication handshake: -Writing to master: Unknown error
[28616] 29 Dec 02:32:57.460 * Connecting to MASTER 127.0.0.1:6379
[28616] 29 Dec 02:32:57.460 * MASTER <-> SLAVE sync started
```
실행 후 위 로그가 연이어 출력 되는데, 정상일 경우에는 sync start만 되는것이 아닌 실제 작업이 일어나야 한다.  
6379 port가 통신할 수 있도록 개방되어 있지 않기 때문에 start만 뜨고 실제 작업은 일어나지 않고 다운 상태로 되어있는것이다.  
아마존 aws에서 여러 인스턴스로 구성했을 경우에는 추가 보안설정을 해줘야 한다.

로컬에서 기동할 경우, 기본적으로 redis-server.exe 파일을 먼저 실행한 뒤[6379-master] 
redis-server.exe redis.windows.conf를 실행해줘야한다[6380-slave(replica)]

- 6379-master 실행
  ```bash
  .\redis-cli.exe
  ```

- 6380-slave 실행
  ```bash
  .\redis-cli.exe -p 6380
  ```


### 실패 2

- 6379-master
  ```text
  [22532] 29 Dec 03:10:16.712 # Server started, Redis version 3.0.504
  [22532] 29 Dec 03:10:16.721 * DB loaded from disk: 0.010 seconds
  [22532] 29 Dec 03:10:16.721 * The server is now ready to accept connections on port 6379
  [22532] 29 Dec 03:10:24.186 * Slave 127.0.0.1:6380 asks for synchronization
  [22532] 29 Dec 03:10:24.186 * Full resync requested by slave 127.0.0.1:6380
  [22532] 29 Dec 03:10:24.186 * Starting BGSAVE for SYNC with target: disk
  [22532] 29 Dec 03:10:24.190 * Background saving started by pid 9452
  [9452] 29 Dec 03:10:24.253 # Failed opening .rdb for saving: Permission denied
  [9452] 29 Dec 03:10:24.254 # rdbSave failed in qfork: Permission denied
  [22532] 29 Dec 03:10:24.337 # fork operation complete
  [22532] 29 Dec 03:10:24.338 # Background saving error
  [22532] 29 Dec 03:10:24.338 # Connection with slave 127.0.0.1:6380 lost.
  [22532] 29 Dec 03:10:24.338 # SYNC failed. BGSAVE child returned an error
  ```

- 6380-slave
  ```text
  Connecting to MASTER 127.0.0.1:6379
  [30316] 29 Dec 03:07:43.664 * MASTER <-> SLAVE sync started
  [30316] 29 Dec 03:07:43.664 * Non blocking connect for SYNC fired the event.
  [30316] 29 Dec 03:07:43.665 # Error reply to PING from master: '-MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.'
  ```

위 오류의 경우 snapshot을 rdb에 저장하는 과정 중 발생하는 오류로, 쓰기 권한을 확인해 봐야 한다.  
redis.windows.conf 파일에 dir ./로 설정 되어있는데, 해당 경로는 Redis 실행파일이 존재하는 해당 경로이다.    
해당 디렉토리의 상위로 이동하여 해당 디렉토리에 쓰기 권한을 준다.  
속성 > 보안 > ALL APPLICATION PACKAGES 선택 > 편집 > 모든권한  
위 설정 후 master와 slave를 모두 재실행 해 준다

아래는 성공시 출력되는 메시지이다.
- 6379-master
  ```text
  [30560] 29 Dec 03:12:07.640 # Server started, Redis version 3.0.504
  [30560] 29 Dec 03:12:07.640 * DB loaded from disk: 0.000 seconds
  [30560] 29 Dec 03:12:07.640 * The server is now ready to accept connections on port 6379
  [30560] 29 Dec 03:12:13.725 * Slave 127.0.0.1:6380 asks for synchronization
  [30560] 29 Dec 03:12:13.726 * Full resync requested by slave 127.0.0.1:6380
  [30560] 29 Dec 03:12:13.726 * Starting BGSAVE for SYNC with target: disk
  [30560] 29 Dec 03:12:13.730 * Background saving started by pid 23132
  [30560] 29 Dec 03:12:13.830 # fork operation complete
  [30560] 29 Dec 03:12:13.831 * Background saving terminated with success
  [30560] 29 Dec 03:12:13.835 * Synchronization with slave 127.0.0.1:6380 succeeded
  ```
- 6380-slave
  ```text
  [5376] 29 Dec 03:12:12.708 # Server started, Redis version 3.0.504
  [5376] 29 Dec 03:12:12.709 * DB loaded from disk: 0.000 seconds
  [5376] 29 Dec 03:12:12.709 * The server is now ready to accept connections on port 6380
  [5376] 29 Dec 03:12:13.723 * Connecting to MASTER 127.0.0.1:6379
  [5376] 29 Dec 03:12:13.723 * MASTER <-> SLAVE sync started
  [5376] 29 Dec 03:12:13.724 * Non blocking connect for SYNC fired the event.
  [5376] 29 Dec 03:12:13.724 * Master replied to PING, replication can continue...
  [5376] 29 Dec 03:12:13.725 * Partial resynchronization not possible (no cached master)
  [5376] 29 Dec 03:12:13.730 * Full resync from master: bcdafeb53dbc73c48d0e0e80d3e5e3965cbdc79e:1
  [5376] 29 Dec 03:12:13.835 * MASTER <-> SLAVE sync: receiving 18 bytes from master
  [5376] 29 Dec 03:12:13.836 * MASTER <-> SLAVE sync: Flushing old data
  [5376] 29 Dec 03:12:13.837 * MASTER <-> SLAVE sync: Loading DB in memory
  [5376] 29 Dec 03:12:13.838 * MASTER <-> SLAVE sync: Finished with success
  ```




</details>


# 템플릿
<details>
<summary>펼치기/접기</summary>

내용
</details>